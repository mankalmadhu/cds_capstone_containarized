from pyspark.ml import PipelineModel
from pyspark.ml.classification import LogisticRegressionModel
from pyspark.ml.feature import IndexToString
import os


def test(spark):
    tweet_pre_processor_model = PipelineModel.load(
        os.environ['tweet_cleaner_pipeline'])

    tweet_feature_extraction_model = PipelineModel.load(
        os.environ['tweet_feature_pipeline'])

    model = LogisticRegressionModel.load(os.environ['trained_model_pipeline'])

    columns = ["text", "id_str"]

    data = [("Good tweet", '2'), ("Bad tweet", '10')]
    test_df = spark.createDataFrame(data).toDF(*columns)
    test_df_pre_processed = tweet_pre_processor_model.transform(test_df)
    test_df_feature_extracted = tweet_feature_extraction_model.transform(
        test_df_pre_processed)

    test_predictions = model.transform(test_df_feature_extracted)

    test_predictions = IndexToString(inputCol="prediction",\
                                            outputCol="predicted_sentiment_string",\
                                            labels = ["Negative","Neutral","Positive"]).\
                                                transform(test_predictions)

    return test_predictions
