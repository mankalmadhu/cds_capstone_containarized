from confluent_kafka import Producer
from ml_boms import KafkaCreds

import json


def delivery_callback(err, msg):
    if err:
        print('%% Message failed delivery: %s\n' % err)
    else:
        print('%% Message delivered to %s [%d]\n' %
              (msg.topic(), msg.partition()))


def push_to_kafka(data_list):

    kafka_creds = KafkaCreds.get_kafka_creds()

    conf = {
        'bootstrap.servers': kafka_creds.confluent_bootstrap_server,
        'session.timeout.ms': 6000,
        'default.topic.config': {
            'auto.offset.reset': 'smallest'
        },
        'security.protocol': 'SASL_SSL',
        'sasl.mechanisms': 'PLAIN',
        'sasl.username': kafka_creds.confluent_api_key,
        'sasl.password': kafka_creds.confluent_secret
    }
    producer = Producer(**conf)
    producer.poll(1)
    print(f'Pushing {len(data_list)} Elements to kafka')
    producer.produce(kafka_creds.confluent_streaming_topic,
                     json.dumps(data_list).encode('utf-8'),
                     callback=delivery_callback)
    producer.flush()
