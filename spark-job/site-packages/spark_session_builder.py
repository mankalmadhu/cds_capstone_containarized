from pyspark.sql import SparkSession
from pyspark import SparkConf, SparkFiles
from cachetools import cached, TTLCache
from ml_boms import StorageCreds


@cached(TTLCache(maxsize=1, ttl=3600))
def build():
    conf = SparkConf()
    conf.set('spark.hadoop.fs.s3a.aws.credentials.provider',
             'org.apache.hadoop.fs.s3a.SimpleAWSCredentialsProvider')
    conf.set('spark.sql.parquet.compression.codec', 'lz4')

    spark = SparkSession.builder.appName("Tweet_Analysis").config(
        conf=conf).getOrCreate()
    sc = spark.sparkContext
    sc.addPyFile(
        SparkFiles.get("/opt/application/site-packages/tweet_cleaner.py"))
    sc.addPyFile(
        SparkFiles.get("/opt/application/site-packages/text_labeler.py"))

    hadoop_config = sc._jsc.hadoopConfiguration()
    storage_creds = StorageCreds.get_storage_creds()
    hadoop_config.set('fs.s3a.access.key', storage_creds.storage_key)
    hadoop_config.set('fs.s3a.secret.key', storage_creds.storage_secret)
    hadoop_config.set("fs.s3a.endpoint", storage_creds.storage_endpoint)

    return spark
