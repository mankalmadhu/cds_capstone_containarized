import os
import time

from celery import Celery, states
import subprocess
from celery.utils.log import get_task_logger
from celery.exceptions import Ignore

celery = Celery(__name__)
celery.conf.broker_url = os.environ["CELERY_BROKER_URL"]
celery.conf.result_backend = os.environ["CELERY_RESULT_BACKEND"]

logger = get_task_logger(__name__)


@celery.task(name="create_task", bind=True)
def create_task(self):
    try:
        subprocess.check_output(
            '/opt/spark/bin/spark-submit local:///opt/application/site-packages/main.py --ops model_test -v > /tmp/spark-submit.log',
            shell=True)
    except subprocess.CalledProcessError as e:
        logger.info(e.output)
        self.update_state(state=states.FAILURE)
        raise Ignore()

    return True
